{
  "version": "1.0",
  "description": "Routing rules for detecting NIKKE queries and delegating to sub-agent. Celeste detects intent and routes appropriately.",
  "last_updated": "2025-11-21",

  "nikke_detection": {
    "keywords": [
      "nikke", "union raid", "ur", "intercept",
      "character", "tier", "tier list", "meta", "best squad",
      "farm", "build", "equipment", "weapon",
      "chapter", "raid", "boss", "strategy", "guide",
      "valiant", "dps", "support", "atk", "def"
    ],
    "patterns": [
      "^(who|which).*(nikke|character).*(best|good|tier)",
      "^(how|tips).*(farm|clear|beat)",
      "^(what).*(meta|tier|build)",
      "^(nikke).*(tier|rank|list)",
      "union.*raid|ur.*guide|nikke.*build",
      "^(should|can).*(use|build|equip)",
      "best.*(nikke|character|team|squad)"
    ]
  },

  "routing_rules": [
    {
      "id": "nikke_query",
      "condition": "query_matches(nikke_detection.keywords) OR query_matches(nikke_detection.patterns)",
      "action": "route_to_sub_agent",
      "sub_agent": {
        "name": "nikke_agent",
        "endpoint_env_var": "NIKKE_AGENT_ENDPOINT",
        "timeout_ms": 10000,
        "auth_key_env_var": "NIKKE_AGENT_KEY"
      },
      "pass_context": [
        "user_id",
        "username",
        "conversation_history",
        "last_5_messages"
      ],
      "response_handling": {
        "on_success": "Pass nikke_agent response back to user with Celeste framing",
        "on_timeout": "Use fallback_message",
        "on_error": "Use fallback_message and log error"
      },
      "fallback_message": "The NIKKE archives are temporarily sealed. Ask again in a moment, onii-chan."
    },
    {
      "id": "general_query",
      "condition": "default || query_intent != 'nikke'",
      "action": "respond_directly",
      "use_prompt": "celeste_essence.json",
      "response_handling": {
        "system_prompt": "celeste_essence.json",
        "include_routing_rules": false,
        "include_context": "conversation_history + user_profile"
      }
    }
  ],

  "intent_detection": {
    "method": "keyword_matching + regex_patterns",
    "fallback": "respond_directly",
    "description": "First check keywords, then patterns. If no match, treat as general query."
  },

  "environment_variables_required": [
    {
      "name": "NIKKE_AGENT_ENDPOINT",
      "description": "Base URL for NIKKE sub-agent API",
      "example": "https://nikke-agent.whykusanagi.xyz/v1/nikke/query"
    },
    {
      "name": "NIKKE_AGENT_KEY",
      "description": "Bearer token for authenticating with NIKKE sub-agent",
      "example": "sk-xxxxxxxx"
    }
  ],

  "opensearch_indices": {
    "celeste_capabilities": {
      "use_case": "Retrieve Celeste's capabilities when asked 'what can you do'",
      "priority": "high"
    },
    "celeste_emotes": {
      "use_case": "Retrieve contextually appropriate 7TV emotes",
      "priority": "medium"
    },
    "celeste_user_profiles": {
      "use_case": "Retrieve user behavior data for moderation/personality",
      "priority": "medium"
    },
    "nikke_characters": {
      "use_case": "Handled by NIKKE sub-agent (not by main Celeste agent)",
      "priority": "handled_by_sub_agent"
    },
    "nikke_tiers": {
      "use_case": "Handled by NIKKE sub-agent (not by main Celeste agent)",
      "priority": "handled_by_sub_agent"
    }
  },

  "performance_targets": {
    "nikke_route_detection_ms": 10,
    "sub_agent_timeout_ms": 10000,
    "fallback_response_ms": 100,
    "general_response_ms": 5000
  }
}
